# 联邦学习系统的系统设计与功能实现

## 一、系统架构设计

### 1.1 总体架构

FLSYS是一个基于Flower框架的联邦学习图像识别系统，采用客户端-服务器架构模式。系统主要由以下几个部分组成：

1. 联邦学习框架层：基于Flower框架，负责联邦学习的基础通信、协调和执行
2. 服务端组件：包括全局模型管理、聚合策略、模型评估等功能
3. 客户端组件：包括本地训练、模型参数更新、数据处理等功能
4. 模型层：支持多种深度学习模型，如简单CNN、MobileNetV3、ResNet18等
5. 配置管理：通过TOML文件管理系统各项参数配置
6. 监控与可视化：使用Weights & Biases (wandb)进行训练过程监控和结果可视化
7. 进程管理：解决Windows环境下的进程管理问题

### 1.2 系统组件关系图

```plaintext
+------------------------------------------------------------------------------------+
|                                  配置管理系统                                       |
|                             (config.toml/pyproject.toml)                                |
+-----------------------------------|-----------------------------------------------+
                                   |
                                   v
+------------------------------------------------------------------------------------+
|                              Flower联邦学习框架                                     |
|  +----------------------+                              +---------------------+      |
|  |     服务端(ServerApp)  |<--------------------------->|  客户端(ClientApp)   |      |
|  +-----------|----------+                              +-----------|--------+      |
|              |                                                     |                |
|  +-----------|----------+                              +-----------|--------+      |
|  |                      |                              |                    |      |
|  |   +-----------------+|                              | +----------------+ |      |
|  |   | 联邦聚合策略     ||                              | | 本地训练逻辑    | |      |
|  |   | - CustomFedAvg  ||                              | | - 参数更新      | |      |
|  |   | - CustomFedAdam ||                              | | - 训练循环      | |      |
|  |   | - CustomFedYogi ||                              | | - 指标计算      | |      |
|  |   +-----------------+|                              | +----------------+ |      |
|  |                      |                              |                    |      |
|  |   +-----------------+|                              | +----------------+ |      |
|  |   | 全局模型评估     ||                              | | 本地模型评估    | |      |
|  |   | - 测试集评估     ||                              | | - 验证集评估    | |      |
|  |   | - 模型保存       ||                              | | - 指标上传      | |      |
|  |   +-----------------+|                              | +----------------+ |      |
|  |                      |                              |                    |      |
|  +----------------------+                              +--------------------+      |
+------------------------------------------------------------------------------------+
                |                                               |
                v                                               v
+------------------------------------------------------------------------------------+
|                                    模型层                                           |
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
|  |   简单CNN (Net)  |  |   MobileNetV3   |  |    ResNet18    |  |  其他可扩展模型  ||
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
+------------------------------------------------------------------------------------+
                |                                               |
                v                                               v
+------------------------------------------------------------------------------------+
|                                 数据处理层                                          |
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
|  |  数据集加载      |  |    数据分区       |  |   数据增强      |  |    数据标准化   ||
|  | (CIFAR10等)     |  | (Dirichlet分区)   |  | (随机裁剪等)    |  |  (归一化处理)   ||
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
+------------------------------------------------------------------------------------+
                                        |
                                        v
+------------------------------------------------------------------------------------+
|                              监控与可视化系统                                        |
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
|  |  WandB集成      |  |   进程监控        |  |   结果保存      |  |   进度报告      ||
|  |  (指标记录)     |  |  (monitor.py)    |  | (JSON格式)     |  | (终端输出)      ||
|  +-----------------+  +------------------+  +----------------+  +-----------------+|
+------------------------------------------------------------------------------------+
```

![系统组件关系图](D:\FLIMSYS\flsys\mermaid-diagram-2025-05-09-164129.png)

## 二、功能设计

### 2.1 服务端功能

#### 2.1.1 全局模型管理

* 模型初始化：根据配置文件选择并初始化全局模型（Net、MobileNetV3、ResNet18等）
* 模型参数处理：将模型参数转换为ndarray格式，用于与客户端交换
* 模型保存：保存每轮训练的全局模型参数和最佳模型

#### 2.1.2 聚合策略

系统支持多种联邦学习聚合策略，所有策略都继承自Flower框架的基础策略，并添加了自定义功能：

* CustomFedAvg：联邦平均算法，将客户端模型参数加权平均
* CustomFedProx：联邦近端算法，加入正则化约束减少客户端与全局模型差异
* CustomFedAdam：使用Adam优化器更新全局模型
* CustomFedAvgM：带动量的联邦平均算法
* CustomFedAdagrad：使用Adagrad优化器更新全局模型
* CustomFedYogi：使用Yogi优化器更新全局模型

#### 2.1.3 评估功能

* 集中式评估：使用测试数据集评估全局模型性能
* 指标聚合：聚合来自客户端的评估指标（如准确率、损失）
* 结果记录：保存评估结果至JSON文件，包括准确率、损失等
* 进度监控：记录训练总时间、进度和模型性能

### 2.2 客户端功能

#### 2.2.1 本地训练

* 参数更新：接收全局模型参数，更新本地模型
* 数据加载：加载分配的本地数据分区
* 本地训练：使用本地数据训练模型指定轮次
* 参数返回：将训练后的模型参数返回服务端
* 指标记录：记录训练损失和其他指标

#### 2.2.2 本地评估

* 模型评估：评估全局模型在本地验证集上的性能
* 指标计算：计算准确率、损失等指标
* 指标上传：将评估指标上传至服务端

### 2.3 模型功能

系统支持多种深度学习模型，可通过配置文件选择：

* Net：简单CNN模型，用于CIFAR10等小型数据集
* MobileNetV3：轻量级CNN模型，适用于移动设备
* ResNet18：残差网络，用于复杂任务

### 2.4 监控与可视化

* WandB集成：实时记录训练指标和性能
* 指标跟踪：跟踪损失、准确率、训练时间等
* 实验管理：支持不同配置的实验比较
* 运行时监控：监控训练过程和进程状态

### 2.5 进程管理

* 训练监控：使用monitor.py监控训练进程
* 优雅退出：确保训练完成后所有进程正常退出
* 资源释放：处理Windows环境下的进程释放问题

## 三、关键技术实现

### 3.1 联邦学习实现

* 模型权重交换：使用parameters_to_ndarrays和ndarrays_to_parameters函数进行模型参数交换
* 聚合机制：通过aggregate_fit方法实现不同聚合策略
* 安全聚合：支持SecAggPlus安全聚合协议
* 评估方式：通过evaluate方法在服务端评估全局模型

### 3.2 数据分区与处理

* Dirichlet分区：使用DirichletPartitioner实现非IID数据分区
* 数据增强：应用随机裁剪、水平翻转等数据增强技术
* 标准化：使用CIFAR10的标准归一化参数

### 3.3 配置管理

* TOML配置：使用TOML格式的配置文件
* 动态加载：支持多种配置路径的自动查找
* 命名空间：将配置组织为模型、wandb、训练和策略命名空间

### 3.4 进程管理解决方案

* 安全终止：使用os.exit(0)安全终止主进程
* 监控脚本：使用monitor.py监控训练进程和wandb同步状态
* 超时控制：支持FLWR_SIMULATION_TIMEOUT环境变量设置超时

## 四、部署方式

系统支持两种部署模式：

### 4.1 模拟引擎部署

```bash
flwr run .
```

适用于本地测试和开发，在单机上模拟多个客户端。

### 4.2 分布式部署

```
# 启动SuperLink服务
flower-superlink --insecure \
--exec-api-address 0.0.0.0:9093 \
--serverappio-api-address 0.0.0.0:9091 \
--fleet-api-address 0.0.0.0:9092

# 启动SuperNode客户端节点
flower-supernode \
     --insecure \
     --superlink 127.0.0.1:9092 \
     --clientappio-api-address 127.0.0.1:9094 \
     --node-config "partition-id=0 num-partitions=2"

# 运行应用
flwr run . local-deployment --stream
```

支持TLS安全连接和证书认证，适用于生产环境部署。

## 五、系统优势与特点

1. 多样化聚合策略：支持多种联邦学习聚合算法，适应不同应用场景
2. 灵活模型选择：支持多种深度学习模型，从轻量级到复杂模型
3. 可视化能力：与WandB集成，提供强大的可视化和实验跟踪能力
4. 安全聚合：支持SecAggPlus安全聚合协议，保护数据隐私
5. 良好扩展性：基于Flower框架，支持轻松扩展新功能和模型
6. 进程管理优化：解决Windows平台下的进程管理问题
